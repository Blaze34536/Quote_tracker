<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFQ List - Professional Hybrid</title>
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #cbd5e1;
            --primary-blue: #2563eb;
            --label-color: #475569;
            --text-main: #1e293b;
            --danger-red: #dc2626;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; font-size: 13px; color: var(--text-main); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav-links { display: flex; gap: 10px; align-items: center; }
        .nav-links a { color: var(--primary-blue); text-decoration: none; font-weight: 600; border: 1px solid #e2e8f0; padding: 6px 14px; border-radius: 6px; background: white; }
        
        .card { background: var(--card-bg); border-radius: 8px; border: 1px solid #e2e8f0; padding: 0; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
        
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: #f1f5f9; color: var(--label-color); font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; padding: 12px 15px; border-bottom: 1px solid var(--border-color); }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; }
        
        tr.main-row:hover { background-color: #f8fafc; cursor: pointer; }
        
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; background: #e0f2fe; color: #0369a1; }

        .action-btns { display: flex; gap: 8px; }
        .btn-edit { color: var(--primary-blue); background: #eff6ff; border: 1px solid #dbeafe; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; }
        .btn-delete { color: var(--danger-red); background: #fef2f2; border: 1px solid #fee2e2; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; }
        .btn-edit:hover { background: #dbeafe; }
        .btn-delete:hover { background: #fee2e2; }

        .parts-container { background: #fdfdfd; padding: 15px; border-bottom: 1px solid var(--border-color); display: none; }
        .parts-container.active { display: block; }
        
        .inner-table { background: white; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px; width: 100%; }
        .inner-table th { background: #fff; border-bottom: 2px solid #f1f5f9; color: var(--primary-blue); }

        .loading { padding: 20px; text-align: center; color: #64748b; font-style: italic; }
    </style>
</head>
<body>

    <div class="header">
        <div><strong>RFQ Tracking History</strong></div>
        <div class="nav-links">
            <a href="/rfq-entry" style="background: var(--primary-blue); color: white;">+ New RFQ</a>
            <a href="/logout">Logout</a>
        </div>
    </div>

    <div class="card">
        <table id="rfqTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>RFQ No</th>
                    <th>Company Name</th>
                    <th>Customer</th>
                    <th>Sales Person</th>
                    <th>Items</th>
                    <th style="width: 140px;">Actions</th>
                </tr>
            </thead>
            <tbody id="rfqListBody"></tbody>
        </table>
        <div id="loader" class="loading">Fetching records from Supabase...</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', fetchRFQs);

        async function fetchRFQs() {
            try {
                const response = await fetch('/api/list-rfq-entry');
                const result = await response.json();
                document.getElementById('loader').style.display = 'none';

                if (result.success) {
                    renderTable(result.data);
                } else {
                    alert("Error: " + result.error);
                }
            } catch (err) {
                console.error(err);
                document.getElementById('loader').innerText = "Failed to load data.";
            }
        }

        function renderTable(data) {
            const body = document.getElementById('rfqListBody');
            body.innerHTML = "";

            if (data.length === 0) {
                body.innerHTML = "<tr><td colspan='7' style='text-align:center;'>No RFQs found.</td></tr>";
                return;
            }

            data.forEach(rfq => {
                const row = document.createElement('tr');
                row.className = 'main-row';
                row.onclick = () => toggleParts(rfq.id);
                
                const dateObj = new Date(rfq.created_at);
                const dateStr = dateObj.toLocaleDateString('en-IN');

                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td><strong>${rfq['RFQ-no'] || 'N/A'}</strong></td>
                    <td>${rfq.Company_name}</td>
                    <td>${rfq.Customer_name || '-'}</td>
                    <td><span class="status-badge">${rfq.Sales_person}</span></td>
                    <td>${rfq.Part_details.length} Items</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-edit" onclick="editRFQ(event, ${rfq.id})">Edit</button>
                            <button class="btn-delete" onclick="deleteRFQ(event, ${rfq.id})">Delete</button>
                        </div>
                    </td>
                `;
                body.appendChild(row);

                const detailRow = document.createElement('tr');
                detailRow.id = `details-${rfq.id}`;
                detailRow.style.display = 'none';
                
                let partsHtml = rfq.Part_details.map(p => `
                    <tr>
                        <td>${p['RFQ-part-no']}</td>
                        <td>${p['Quoted-part-no'] || '-'}</td>
                        <td>${p['Supplier'] || '-'}</td>
                        <td>${p['RFQ Qty']}</td>
                        <td>$${p['Unit$'] ? p['Unit$'].toFixed(2) : '0.00'}</td>
                        <td>₹${p['Unit₹'] ? p['Unit₹'].toFixed(2) : '0.00'}</td>
                        <td>${p['Remarks'] || '-'}</td>
                    </tr>
                `).join('');

                detailRow.innerHTML = `
                    <td colspan="7" style="padding:0;">
                        <div class="parts-container">
                            <table class="inner-table">
                                <thead>
                                    <tr>
                                        <th>RFQ Part #</th>
                                        <th>Quoted Part #</th>
                                        <th>Supplier</th>
                                        <th>Qty</th>
                                        <th>Unit ($)</th>
                                        <th>Unit (₹)</th>
                                        <th>Remarks</th>
                                    </tr>
                                </thead>
                                <tbody>${partsHtml}</tbody>
                            </table>
                        </div>
                    </td>
                `;
                body.appendChild(detailRow);
            });
        }

        function toggleParts(id) {
            const detailRow = document.getElementById(`details-${id}`);
            const container = detailRow.querySelector('.parts-container');
            
            if (detailRow.style.display === 'none') {
                detailRow.style.display = 'table-row';
                setTimeout(() => container.classList.add('active'), 10);
            } else {
                container.classList.remove('active');
                setTimeout(() => detailRow.style.display = 'none', 200);
            }
        }

        function editRFQ(event, id) {
            event.stopPropagation(); // Prevents toggling the detail view
            window.location.href = `/rfq-entry?edit=${id}`;
        }

        async function deleteRFQ(event, id) {
            event.stopPropagation();
            if (!confirm("Are you sure you want to delete this RFQ? This action cannot be undone.")) return;

            try {
                const response = await fetch(`/api/delete-rfq/${id}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    alert("RFQ deleted successfully.");
                    fetchRFQs(); // Refresh list
                } else {
                    alert("Error: " + result.error);
                }
            } catch (err) {
                alert("Failed to delete RFQ.");
            }
        }
    </script>
</body>
</html>